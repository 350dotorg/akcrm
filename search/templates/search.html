{% extends "base.html" %}
{% load helpful_tags verbatim %}
<html>
<head>
  {% block head %}
  <script type="text/javascript" src="/static/datatables/js/jquery.dataTables.js"></script>
  <link rel="stylesheet" type="text/css" href="/static/datatables/css/demo_table_jui.css" />
  <link rel="stylesheet" type="text/css" href="/static/smoothness/jquery-ui.custom.css" />
  <script type="text/javascript">
    $(window).load(function() {
      $("#num_results").text($("tr.gradeA").length);
      $("table#ngot_data").dataTable({
        "bJQueryUI": true,
        "sPaginationType": "full_numbers"
      });
    });

    $(".expand").live("click", function() {
      $("tr.expand_details").remove();
        var expanded = $('<tr class="expand_details"><td colspan="8" class="group">' +
	'<div>Loading details; please wait, or <a href="' + $(this).attr("href") +
        '">click here</a> to view full details</div></td></tr>'
        ).insertAfter($(this).closest("tr"));
      $.getJSON($(this).attr("href") + "json/", function(data) {
        var output = Mustache.render($("#details_tmpl").text(), data);
        expanded.find("td.group div").html(output + expanded.find("td.group div a")[0].outerHTML);
      });
      return false;
    });
  </script>
  <script type="text/javascript_template" id="details_tmpl">
    {% verbatim %}
    <div class="span6">
      <p>
	<strong>Latest Activity:</strong>
	{{ latest_action.created_at }} &ndash; {{ latest_action.page_title }}
      </p>
      <p>
	<strong>Latest Contribution:</strong>
	{{ latest_order.created_at }} &ndash; {{ latest_order.action.page_title }} 
	&ndash; ${{ latest_order.total }}
      </p>
      <p>
	<strong>Opens:</strong> {{ opens.length }}
	&mdash;
	<strong>Clicks:</strong> {{ clicks.length }}
	&mdash;
	<strong>Sends:</strong> {{ sends.length }}
      </p>
    </div>
    <div class="span6">
      <p>
	<strong>Latest Mailing:</strong>
	{{ latest_send.created_at }} &ndash; {{ latest_send.subject_text }}
	&ndash; sent {{ latest_send.created_at }}
      </p>
      <p>
	<strong>Latest Open:</strong>
	{{ latest_open.created_at }} &ndash; {{ latest_open.subject_text }}
	&ndash; sent {{ latest_open.mailed_at }}
      </p>
      <p>
	<strong>Latest Click:</strong>
	{{ latest_click.created_at }} &ndash; {{ latest_click.subject_text }}
	&ndash; sent {{ latest_click.mailed_at }}
      </p>
    </div>
    {% endverbatim %}
  </script>
  {% endblock %}
</head>
<body>
  {% block nav %}
  <li><a href="{% url home %}">New Search</a></li>
  <li><a target="_blank" href="{% url search_raw_sql %}{{request.GET|qsify}}">Get Raw SQL for ActionKit Mailings</a></li>
  <li><a target="_blank" href="{% url search_just_akids %}{{request.GET|qsify}}">Get AKIDs for Actionkit Includes/Excludes</a></li>
  {% endblock %}

  {% block content %}
<h1>Found: <span id="num_results">{{ users|length }}</span> people</h1>
<div>
Searched for people who match::
<pre>{{ human_query }}</pre>
</div>

<div class="datatables_wrapper">
<table class="display" id="ngot_data">
  <thead>
  <tr>
    <th>Name</th>
    <th>Email</th>
    <th>Phone</th>
    <th>Country</th>
    <th>State</th>
    <th>City</th>
    <th>Organization</th>
    <th>Sign-up Date</th>
  </tr>
  </thead>
  <tbody>
  {% for user in users %}
  {% ifchanged user %}
  <tr class="gradeA">
    <td><a class="expand" href="{{ user.get_absolute_url }}">
	{{ user|default:"" }}</a></td>
    <td><a class="expand" href="{{ user.get_absolute_url }}">
	{{ user.email|default:"" }}</a></td>
    <td>{{ user.phone|default:"" }}</td>
    <td>{{ user.country|default:"" }}</td>
    <td>{{ user.state|default:"" }}</td>
    <td>{{ user.city|default:"" }}</td>
    <td>{{ user.organization|default:"" }}</td>
    <td>{{ user.created_at|date:"Y/m/d" }}</td>
  </tr>
  {% endifchanged %}
  {% endfor %}
  </tbody>
</table>
</div>

{% endblock %}

</body>
</html>
